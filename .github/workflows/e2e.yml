name: e2e-test
on:
  push:
    branches:
    - "*"
  pull_request:
jobs:
  e2e-test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        node:
        - v1.19.4
        - v1.20.0
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - name: Set up kubectl
      uses: azure/setup-kubectl@v1
      with:
        version: ${{ matrix.node }}
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
    - name: Build Container Image
      uses: docker/build-push-action@v2
      with:
        context: .
        file: ./Dockerfile
        load: true
        platforms: linux/amd64
        push: false
        tags: ghcr.io/${{ github.repository }}:ci
    - name: Set up KinD
      uses: engineerd/setup-kind@v0.5.0
      with:
        config: ./hack/e2e-kind-config.yaml
        image: kindest/node:${{ matrix.node }}
        version: "v0.9.0"
    - name: Wait for KiND readiness
      run: |
          kubectl --namespace kube-system wait --for=condition=ready pod -l tier=control-plane --timeout=300s
          kubectl get nodes -o wide
    - name: Load image on the nodes of the KinD
      run: |
          kind load docker-image ghcr.io/${{ github.repository }}:ci
    - name: Patch Install Manifests
      run: |
          sed -i -e 's@imagePullPolicy: Always@imagePullPolicy: IfNotPresent@g' ./deploy/ha-install.yaml
          sed -i -e 's@image: .*@image: ghcr.io/${{ github.repository }}:ci@g' ./deploy/ha-install.yaml
    - name: Deploy Application
      id: deployment
      run: |
        kubectl apply -f ./deploy/ha-install.yaml
        kubectl --namespace kubelet-serving-cert-approver wait --for=condition=ready pod --selector app.kubernetes.io/name=kubelet-serving-cert-approver --timeout=300s
    - name: Get deployment failure logs
      if: steps.deployment.outputs.exit_code != 0
      run: |
        kubectl --namespace kubelet-serving-cert-approver get events
        kubectl --namespace kubelet-serving-cert-approver describe deployments kubelet-serving-cert-approver
    - name: Test Approved Certificate Signing Requests
      run: |
        kubectl get csr --field-selector spec.signerName=kubernetes.io/kubelet-serving -o jsonpath='{range .items[?(@.status.conditions[*].type=="Approved")]}{.metadata.name}{"\n"}{end}' | grep .
    - name: Get Application logs
      if: ${{ always() }}
      run: |
        kubectl --namespace kubelet-serving-cert-approver logs --selector app.kubernetes.io/name=kubelet-serving-cert-approver --prefix
